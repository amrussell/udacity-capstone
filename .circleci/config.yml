version: 2.1
jobs:
    build:
        docker:
            - image: node:lts-alpine3.13
        steps:
            - checkout
            - restore_cache:
                keys: [build]
            - run:
                name: Build Node app
                command: |
                    npm install
                    npm run lint
            - save_cache:
                paths: [node_modules]
                key: build

    ecr-publish:
        docker:
            - image: amazon/aws-cli
        steps:
            - checkout
            - run:
                name: Build and push Docker image
                command: |
                    apt-get install docker -y
                    DOCKERPATH=amrussell/udacity-capstone:latest
                    docker build -f Dockerfile -t $DOCKERPATH . -q
                    aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.us-east-1.amazonaws.com
                    echo "Pushing image to $DOCKERPATH"
                    docker push $DOCKERPATH
